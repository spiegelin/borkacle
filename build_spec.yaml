version: 0.1
component: build

timeoutInSeconds: 3600

env:
  variables:
    REGISTRY: mx-queretaro-1.ocir.io
    NAMESPACE: axtwc9mqbq4b
    FRONTEND_REPO: borkacle-frontend
    BOT_REPO: borkacle-bot
    CONTROLLER_REPO: borkacle-controller

steps:
  - type: Command
    name: Login to OCIR
    command: |
      echo "ðŸ”‘ Autenticando en OCIR..."
      echo "${DEVOPS_AUTH_TOKEN}" \
        | docker login $REGISTRY \
            -u "${DEVOPS_USERNAME}" \
            --password-stdin

  - type: Command
    name: Define unique image tag
    timeoutInSeconds: 40
    command: |
      export BUILDRUN_HASH=$(echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-7)
      echo "BUILDRUN_HASH=$BUILDRUN_HASH" > build_vars.env

  - type: Command
    name: Load Image Tag
    command: |
      source build_vars.env
      echo "Loaded BUILDRUN_HASH=$BUILDRUN_HASH"

  - type: Command
    name: Build Frontend  
    command: |
      source build_vars.env
      docker build --pull --no-cache \
        -t ${REGISTRY}/${NAMESPACE}/${FRONTEND_REPO}:${BUILDRUN_HASH} \
        ./frontend

  - type: Command
    name: Push Frontend
    command: |
      source build_vars.env
      docker push ${REGISTRY}/${NAMESPACE}/${FRONTEND_REPO}:${BUILDRUN_HASH}

  - type: Command
    name: Build Bot
    command: |
      source build_vars.env
      docker build --pull --no-cache \
        -t ${REGISTRY}/${NAMESPACE}/${BOT_REPO}:${BUILDRUN_HASH} \
        ./bot

  - type: Command
    name: Push Bot
    command: |
      source build_vars.env
      docker push ${REGISTRY}/${NAMESPACE}/${BOT_REPO}:${BUILDRUN_HASH}

  - type: Command
    name: Build Controller
    command: |
      source build_vars.env
      docker build --pull --no-cache \
        -t ${REGISTRY}/${NAMESPACE}/${CONTROLLER_REPO}:${BUILDRUN_HASH} \
        ./controller

  - type: Command
    name: Push Controller
    command: |
      source build_vars.env
      docker push ${REGISTRY}/${NAMESPACE}/${CONTROLLER_REPO}:${BUILDRUN_HASH}

  - type: Command
    name: Show Image URIs
    command: |
      source build_vars.env
      echo "FRONTEND_IMAGE=${REGISTRY}/${NAMESPACE}/${FRONTEND_REPO}:${BUILDRUN_HASH}"
      echo "BOT_IMAGE=${REGISTRY}/${NAMESPACE}/${BOT_REPO}:${BUILDRUN_HASH}"
      echo "CONTROLLER_IMAGE=${REGISTRY}/${NAMESPACE}/${CONTROLLER_REPO}:${BUILDRUN_HASH}"

outputArtifacts:
  - name: frontend-deployment
    type: BINARY
    location: k8s/frontend-deployment.yaml

  - name: bot-deployment
    type: BINARY
    location: k8s/bot-deployment.yaml

  - name: controller-deployment
    type: BINARY
    location: k8s/controller-deployment.yaml
