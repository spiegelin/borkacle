version: 0.1
component: build
shell: bash

env:
  variables:
    REGION: mx-queretaro-1
    REGISTRY_NAMESPACE: axtwc9mqbq4b
    IMAGE_TAG: "${BUILD_RUN_ID}"

steps:
  - type: Command
    name: Login to OCIR
    command: |
      echo "Logging in to OCIR with the following user:"
      echo "${DEVOPS_USERNAME}"
      docker login ${REGION}.ocir.io \
        --username "${DEVOPS_USERNAME}" \
        --password "${DEVOPS_AUTH_TOKEN}"

  - type: Command
    name: DockerHub Login
    command: |
      echo "Logging in to DockerHub..."
      echo "${DOCKERHUB_PASSWORD}" | docker login --username "${DOCKERHUB_USERNAME}" --password-stdin

  - type: Command
    name: Build Frontend
    command: |
      docker build -t ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-frontend:${IMAGE_TAG} ./frontend

  - type: Command
    name: Push Frontend
    command: |
      docker push ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-frontend:${IMAGE_TAG}

  - type: Command
    name: Build Bot
    command: |
      docker build -t ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-bot:${IMAGE_TAG} ./bot

  - type: Command
    name: Push Bot
    command: |
      docker push ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-bot:${IMAGE_TAG}

  - type: Command
    name: Build Controller
    command: |
      docker build -t ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-controller:${IMAGE_TAG} ./controller

  - type: Command
    name: Push Controller
    command: |
      docker push ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-controller:${IMAGE_TAG}

  - type: Command
    name: Reemplazar imÃ¡genes en YAMLs
    command: |
      FRONTEND_IMAGE=${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-frontend:${IMAGE_TAG}
      BOT_IMAGE=${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-bot:${IMAGE_TAG}
      CONTROLLER_IMAGE=${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-controller:${IMAGE_TAG}

      sed "s|__FRONTEND_IMAGE__|$FRONTEND_IMAGE|g" k8s/frontend-deployment.yaml > k8s/frontend-deployment.generated.yaml
      sed "s|__BOT_IMAGE__|$BOT_IMAGE|g" k8s/bot-deployment.yaml > k8s/bot-deployment.generated.yaml
      sed "s|__CONTROLLER_IMAGE__|$CONTROLLER_IMAGE|g" k8s/controller-deployment.yaml > k8s/controller-deployment.generated.yaml

outputArtifacts:
  - name: frontend-deployment
    type: BINARY
    location: k8s/frontend-deployment.generated.yaml

  - name: bot-deployment
    type: BINARY
    location: k8s/bot-deployment.generated.yaml

  - name: controller-deployment
    type: BINARY
    location: k8s/controller-deployment.generated.yaml
