version: 0.1
component: build
shell: bash

env:
  variables:
    REGION: mx-queretaro-1
    REGISTRY_NAMESPACE: axtwc9mqbq4b

steps:
  - type: Command
    name: Login to OCIR
    command: |
      echo "Logging in to OCIR..."
      docker login ${REGION}.ocir.io \
        --username "${DEVOPS_USERNAME}" \
        --password "${DEVOPS_AUTH_TOKEN}"

  - type: Command
    name: DockerHub Login
    command: |
      echo "Logging in to DockerHub..."
      echo "${DOCKERHUB_PASSWORD}" | docker login --username "${DOCKERHUB_USERNAME}" --password-stdin

  - type: Command
    name: Build Frontend
    command: |
      docker build -t ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-frontend:${OCI_BUILD_RUN_ID} ./frontend

  - type: Command
    name: Push Frontend
    command: |
      docker push ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-frontend:${OCI_BUILD_RUN_ID}

  - type: Command
    name: Build Bot
    command: |
      docker build -t ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-bot:${OCI_BUILD_RUN_ID} ./bot

  - type: Command
    name: Push Bot
    command: |
      docker push ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-bot:${OCI_BUILD_RUN_ID}

  - type: Command
    name: Build Controller
    command: |
      docker build -t ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-controller:${OCI_BUILD_RUN_ID} ./controller

  - type: Command
    name: Push Controller
    command: |
      docker push ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-controller:${OCI_BUILD_RUN_ID}

  - type: RunDeployment
    name: Deploy Borkacle Images
    deploymentPipelineId: ${DEPLOYMENT_PIPELINE_ID}
    parameters:
      - name: FRONTEND_IMAGE
        value: ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-frontend:${OCI_BUILD_RUN_ID}
      - name: BOT_IMAGE
        value: ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-bot:${OCI_BUILD_RUN_ID}
      - name: CONTROLLER_IMAGE
        value: ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-controller:${OCI_BUILD_RUN_ID}

outputArtifacts:
  - name: frontend-deployment
    type: BINARY
    location: k8s/frontend-deployment.yaml

  - name: bot-deployment
    type: BINARY
    location: k8s/bot-deployment.yaml

  - name: controller-deployment
    type: BINARY
    location: k8s/controller-deployment.yaml
