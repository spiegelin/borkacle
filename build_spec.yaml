version: 0.1
component: build
shell: bash

env:
  variables:
    REGION: mx-queretaro-1
    REGISTRY_NAMESPACE: axtwc9mqbq4b
    IMAGE_TAG: "1.0.3"

steps:
  - type: Command
    name: Login to OCIR
    command: |
      echo "Logging in to OCIR with the following user:"
      echo "${DEVOPS_USERNAME}"
      echo "Running docker login command..."
      docker login ${REGION}.ocir.io \
        --username "${DEVOPS_USERNAME}" \
        --password "${DEVOPS_AUTH_TOKEN}"

  - type: Command
    name: DockerHub Login
    command: |
      echo "Logeando a DockerHub..."
      echo "${DOCKERHUB_PASSWORD}" | docker login --username "${DOCKERHUB_USERNAME}" --password-stdin

  - type: Command
    name: Build Frontend
    command: |
      docker build -t ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-frontend:${IMAGE_TAG} ./frontend

  - type: Command
    name: Push Frontend
    command: |
      docker push ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-frontend:${IMAGE_TAG}

  - type: Command
    name: Build Bot
    command: |
      docker build -t ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-bot:${IMAGE_TAG} ./bot

  - type: Command
    name: Push Bot
    command: |
      docker push ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-bot:${IMAGE_TAG}

  - type: Command
    name: Build Controller
    command: |
      docker build -t ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-controller:${IMAGE_TAG} ./controller

  - type: Command
    name: Push Controller
    command: |
      docker push ${REGION}.ocir.io/${REGISTRY_NAMESPACE}/borkacle-controller:${IMAGE_TAG}

outputArtifacts:
  - name: frontend-deployment
    type: BINARY
    location: k8s/frontend-deployment.yaml

  - name: bot-deployment
    type: BINARY
    location: k8s/bot-deployment.yaml

  - name: controller-deployment
    type: BINARY
    location: k8s/controller-deployment.yaml
